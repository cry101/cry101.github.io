<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Cary"><meta name="keywords" content="个人博客"><meta name="description" conauthortent="若尧的博客"><link rel="alternative" href="/atom.xml" title="若尧" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>create-react-app中配置webpack - 若尧</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><div class="hide" id="particles-oli-wrapper"></div><header class="head"><h1 class="head-title u-fl"><a href="/">若尧</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">目录</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">关于</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-04-20T01:47:04.000Z">四月 20, 2018</time><h1 class="post__title"><a href="/2018/04/20/webpack-01/">create-react-app中配置webpack</a></h1><div class="post__main echo"><p><a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener">Create React App</a>（以下简称 CRA）是创建 React 应用的一个脚手架，它与其他脚手架不同的一个地方就是将一些复杂工具（比如 webpack）的配置封装了起来，让使用者不用关心这些工具的具体配置，从而降低了工具的使用难度。<br>当我们想自己配置webpack的时候可以通过以下几种方式：</p>
<h3 id="1-npm-run-eject"><a href="#1-npm-run-eject" class="headerlink" title="1.npm run eject"></a>1.npm run eject</h3><p>用脚手架创建的项目，package.json 里提供了一条命令：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"eject"</span>: <span class="string">"react-scripts eject"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行完这条命令，会将封装在CRA中的配置全部反编译到当前项目，这样会直接暴露出webpack的配置，可以直接修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># eject 后项目根目录下会出现 config 文件夹，里面就包含了 webpack 配置</span><br><span class="line">config</span><br><span class="line">├── env.js</span><br><span class="line">├── jest</span><br><span class="line">│   ├── cssTransform.js</span><br><span class="line">│   └── fileTransform.js</span><br><span class="line">├── paths.js</span><br><span class="line">├── polyfills.js</span><br><span class="line">├── webpack.config.dev.js // 开发环境配置</span><br><span class="line">├── webpack.config.prod.js // 生产环境配置</span><br><span class="line">└── webpackDevServer.config.js</span><br></pre></td></tr></table></figure></p>
<p>CRA 与其他脚手架不同的另一个地方，就是可以通过升级其中的react-scripts包来升级 CRA 的特性。比如用老版本 CRA 创建了一个项目，这个项目不具备 PWA 功能，但只要项目升级了react-scripts包的版本就可以具备 PWA 的功能，项目本身的代码不需要做任何修改。</p>
<p>但如果我们使用了eject命令，就再也享受不到 CRA 升级带来的好处了，因为react-scripts已经是以文件的形式存在于你的项目，而不是以包的形式，所以无法对其升级。</p>
<h3 id="2-替换react-scripts包"><a href="#2-替换react-scripts包" class="headerlink" title="2.替换react-scripts包"></a>2.替换react-scripts包</h3><p><a href="https://github.com/facebook/create-react-app/tree/8cae659ec5a066eff8ea270346dc8c1ef064f9aa/packages/react-scripts" target="_blank" rel="noopener">react-script</a>react-scripts 是 CRA 的一个核心包，一些脚本和工具的默认配置都集成在里面，使用 CRA 创建项目默认就是使用这个包，但是 CRA 还提供了另外一种方式来创建 CRA 项目，即使用自定义 scripts 包的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 默认方式</span><br><span class="line">$ create-react-app foo</span><br><span class="line"></span><br><span class="line"># 自定义 scripts 包方式</span><br><span class="line">$ create-react-app foo --scripts-version 自定义包</span><br></pre></td></tr></table></figure>
<p>自定义包可以是下面几种形式：<br>(1)react-scripts包的版本号，比如0.8.2，这种形式可以用来安装低版本的react-scripts包。<br>(2)一个已经发布到 npm 仓库上的包的名字，比如your-scripts，里面包含了修改过的 webpack 配置。<br>(3)一个 tgz 格式的压缩文件，比如/your/local/scripts.tgz，通常是未发布到 npm 仓库的自定义 scripts 包，可以用 npm pack 命令生成。<br>这种方式相对于之前的eject是一种更灵活地修改 webpack 配置的方式，而且可以做到和 CRA 一样，通过升级 scrips 包来升级项目特性。</p>
<p>自定义 scripts 包的结构可以参照react-scripts包的结构，只要修改对应的 webpack 配置文件，并安装上所需的 webpack loader 或 plugin 包就可以了。</p>
<h3 id="3-使用react-app-rewired"><a href="#3-使用react-app-rewired" class="headerlink" title="3.使用react-app-rewired"></a>3.使用react-app-rewired</h3><p>虽然有这两种方式可以扩展 webpack 配置，但是很多开发者还是觉得太麻烦，有没有一种方式可以既不用eject项目又不用创建自己的 scripts 包呢？<br>答案是肯定的，<a href="https://github.com/timarney/react-app-rewired" target="_blank" rel="noopener">react-app-rewired</a> 是 react 社区开源的一个修改 CRA 配置的工具。</p>
<p>在 CRA 创建的项目中安装了react-app-rewired后，可以通过创建一个config-overrides.js 文件来对 webpack 配置进行扩展。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* config-overrides.js */</span></span><br><span class="line"><span class="keyword">const</span> &#123; injectBabelPlugin &#125; = <span class="built_in">require</span>(<span class="string">'react-app-rewired'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> path.join(__dirname, <span class="string">'.'</span>, dir)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">override</span>(<span class="params">config, env</span>) </span>&#123;</span><br><span class="line">	config = injectBabelPlugin([<span class="string">'import'</span>, &#123; <span class="attr">libraryName</span>: <span class="string">'antd-mobile'</span>, <span class="attr">style</span>: <span class="string">'css'</span> &#125;], config);</span><br><span class="line"></span><br><span class="line">	config.resolve.alias = &#123;</span><br><span class="line">		<span class="string">'@'</span>: resolve(<span class="string">'src'</span>)</span><br><span class="line">	&#125;;</span><br><span class="line">	config.devtool = process.env.NODE_ENV === <span class="string">'development'</span>? <span class="string">'#eval-source-map'</span>: <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>override方法的第一个参数config就是 webpack 的配置，在这个方法里面，我们可以对 config 进行扩展，比如安装其他 loader 或者 plugins，最后再将这个 config 对象返回回去。</p>
<p>最后再修改package.json中的脚本命令<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* package.json */</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">-   "start": "react-scripts start",</span><br><span class="line">+   "start": "react-app-rewired start",</span><br><span class="line">-   "build": "react-scripts build",</span><br><span class="line">+   "build": "react-app-rewired build",</span><br><span class="line">-   "test": "react-scripts test --env=jsdom",</span><br><span class="line">+   "test": "react-app-rewired test --env=jsdom"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-scripts-包-override-组合"><a href="#4-scripts-包-override-组合" class="headerlink" title="4.scripts 包 + override 组合"></a>4.scripts 包 + override 组合</h3><p>虽然react-app-rewired的方式已经可以很方便地修改 webpack 的配置了，但其实我们也可以在自定义的 script 包中实现类似的功能。</p>
<p>在react-app-rewired的源码中可以看到它核心的包也叫 react-app-rewired，里面重新覆盖了react-scripts中的几个脚本文件，包括build.js、start.js和test.js。</p>
<p>具体过程是怎样的呢？以build.js为例：<br>(1)先获取 webpack 的基本配置，然后再调用config-overrides.js（就是在根目录中新增的那个文件）中的override方法，将原先的 webpack 对象作为参数传入，<br>(2)再取得经过修改后的 webpack 配置对象<br>(3)最后再调用react-scripts中的build.js脚本，传入修改后的 webpack 对象来执行命令，<br>具体源码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> overrides = <span class="built_in">require</span>(<span class="string">'../config-overrides'</span>);</span><br><span class="line"><span class="keyword">const</span> webpackConfigPath = paths.scriptVersion + <span class="string">"/config/webpack.config.prod"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// load original config</span></span><br><span class="line"><span class="keyword">const</span> webpackConfig = <span class="built_in">require</span>(webpackConfigPath);</span><br><span class="line"><span class="comment">// override config in memory</span></span><br><span class="line"><span class="built_in">require</span>.cache[<span class="built_in">require</span>.resolve(webpackConfigPath)].exports =</span><br><span class="line">  overrides.webpack(webpackConfig, process.env.NODE_ENV);</span><br><span class="line"><span class="comment">// run original script</span></span><br><span class="line"><span class="built_in">require</span>(paths.scriptVersion + <span class="string">'/scripts/build'</span>);</span><br></pre></td></tr></table></figure></p>
<p>知道了原理之后，我们也可以修改自定义 scripts 包的脚本文件，还是以build.js为例，在获取基本 webpack 配置对象和使用 webpack 对象之间加入以下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// override config</span></span><br><span class="line"><span class="keyword">const</span> override = <span class="built_in">require</span>(paths.configOverrides);</span><br><span class="line"><span class="keyword">const</span> overrideFn = override || <span class="function">(<span class="params">(config, env</span>) =&gt;</span> config);</span><br><span class="line"><span class="keyword">const</span> overrideConfig = overrideFn(config, process.env.NODE_ENV);</span><br></pre></td></tr></table></figure></p>
<p>overrideConfig就是修改后的 webpack 对象，最后修改调用了 webpack 对象的代码，将原来的 webpack 对象替换成修改后的 webpack 对象。</p>
<p><a href="https://zhaozhiming.github.io/blog/2018/01/08/create-react-app-override-webpack-config/" target="_blank" rel="noopener">原文地址</a></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/react/">react</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/webpack/">webpack</a></li></ul></footer></article><link rel="stylesheet" href="/css/menu.css"><script src="/js/jquery.autoMenu.js"></script><div class="autoMenu" id="autoMenu" data-autoMenu></div><section class="reward"> <a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechatImage.jpg" title="微信"><img src="/img/alipayImage.jpg" title="支付宝"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 Cary</div></footer><!--include ../plugins/google.pug--><script src="/js/particles.min.js"></script><script src="/js/particles.other.js"></script><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>